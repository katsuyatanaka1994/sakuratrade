name: pr-draft-on-fail
on:
  workflow_run:
    workflows: ["docs-index-validate", "nfr-xref", "security-permissions-lint"]
    types: [completed]
permissions:
  pull-requests: write
jobs:
  draft:
    if: ${{ github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const pr  = run.pull_requests?.[0];
            if (!pr) return;

            const { owner, repo } = context.repo;
            await github.rest.pulls.update({ owner, repo, pull_number: pr.number, draft: true });
            await github.rest.issues.createComment({
              owner, repo, issue_number: pr.number,
              body: "ğŸš§ ãƒã‚§ãƒƒã‚¯å¤±æ•—ã®ãŸã‚ PR ã‚’ Draft ã«æˆ»ã—ã¾ã—ãŸã€‚ä¿®æ­£å¾Œã« Ready for review ã¸ã€‚"
            });
