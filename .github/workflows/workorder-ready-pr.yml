name: workorder-ready/pr-sanity

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review, labeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  guard:
    name: workorder-ready/pr-sanity
    if: github.event.pull_request.base.ref == 'main'
    env:
      WORKORDER_ALLOWED_PATHS: ${{ vars.WORKORDER_ALLOWED_PATHS || '' }}
      WORKORDER_BLOCKED_PATHS: ${{ vars.WORKORDER_BLOCKED_PATHS || 'alembic/**,infra/**,migrations/**' }}
      WORKORDER_MAX_TASK_LINES: ${{ vars.WORKORDER_MAX_TASK_LINES || '80' }}
      WORKORDER_MAX_PR_LINES: ${{ vars.WORKORDER_MAX_PR_LINES || '120' }}
      WORKORDER_MAX_FILE_LINES: ${{ vars.WORKORDER_MAX_FILE_LINES || '80' }}
      WORKORDER_MAX_TOTAL_LINES: ${{ vars.WORKORDER_MAX_TOTAL_LINES || '180' }}
      WORKORDER_MAX_LINES_PER_ITER: ${{ vars.WORKORDER_MAX_LINES_PER_ITER || '60' }}
      WORKORDER_MAX_ITERATIONS: ${{ vars.WORKORDER_MAX_ITERATIONS || '3' }}
      WORKORDER_MAX_CHANGED_FILES: ${{ vars.WORKORDER_MAX_CHANGED_FILES || '6' }}
      WORKORDER_RUN_REPORT: tmp/workorder_limits_report.json
    runs-on: ubuntu-latest
    steps:
      - name: Determine run context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = new Set((pr.labels || []).map(label => label?.name));
            const reason = (msg) => core.setOutput('reason', msg ?? '');
            if (!labels.has('plan:sync')) {
              core.info('Skipping: plan:sync label missing');
              reason('missing plan:sync label');
              return;
            }
            if (pr.head?.ref === 'docs-sync/workorder') {
              core.info('Skipping: docs-sync/workorder PR should not trigger sanity guard');
              reason('docs-sync/workorder self trigger');
              return;
            }
            const headRepo = pr.head?.repo?.full_name || '';
            const sameRepo = headRepo.toLowerCase() === `${context.repo.owner}/${context.repo.repo}`.toLowerCase();
            if (!sameRepo) {
              core.info('Skipping: fork PR is not evaluated');
              reason('fork pull request');
              return;
            }
            core.setOutput('should_run', 'true');
            core.setOutput('source_pr', String(pr.number));
            core.setOutput('source_head', pr.head?.ref ?? '');
            core.setOutput('head_sha', pr.head?.sha ?? '');

      - name: Skip (not applicable)
        if: steps.context.outputs.should_run != 'true'
        run: echo "workorder-ready pr sanity skipped: ${{ steps.context.outputs.reason || 'condition not met' }}"

      - name: Checkout PR head
        if: steps.context.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.context.outputs.head_sha || github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch
        if: steps.context.outputs.should_run == 'true'
        run: |
          git fetch --no-tags --depth=1 origin "${{ github.event.pull_request.base.ref }}"

      - name: Configure git user
        if: steps.context.outputs.should_run == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup Python
        if: steps.context.outputs.should_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.context.outputs.should_run == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML==6.0.2

      - name: Sync workorder AUTO sections (dry run)
        if: steps.context.outputs.should_run == 'true'
        run: |
          set -euo pipefail
          python -m scripts.workorder_cli ready

      - name: Run workorder guard (dry run)
        if: steps.context.outputs.should_run == 'true'
        id: guard
        continue-on-error: true
        env:
          WORKORDER_DIFF_RANGE: origin/${{ github.event.pull_request.base.ref }}...HEAD
        run: |
          set -euo pipefail
          python scripts/workorder_guard.py

      - name: Handle guard result
        if: steps.context.outputs.should_run == 'true' && steps.guard.outcome == 'failure'
        uses: actions/github-script@v7
        env:
          REPORT_PATH: ${{ env.WORKORDER_RUN_REPORT }}
        with:
          script: |
            const fs = require('fs');
            try {
              const report = JSON.parse(fs.readFileSync(process.env.REPORT_PATH, 'utf-8'));
              const status = report.status || 'unknown';
              let message = 'ðŸ›‘ workorder-ready sanity check failed.';
              if (status === 'disallowed') {
                const files = (report.disallowed_files || []).join(', ') || 'unknown';
                message += ` Disallowed paths detected: ${files}.`;
              } else if (status === 'blocked_paths') {
                const files = (report.blocked_files || []).join(', ') || 'unknown';
                message += ` Blocked paths detected: ${files}.`;
              } else if (status === 'limit_exceeded') {
                const reasons = [];
                for (const item of report.file_over_limit || []) {
                  reasons.push(`${item.path} (${item.total}/${item.limit})`);
                }
                if (report.total_over_limit) {
                  const total = report.stats?.total_lines ?? 'unknown';
                  reasons.push(`total lines ${total}`);
                }
                if (report.file_count_over_limit) {
                  const files = report.stats?.file_count ?? 'unknown';
                  reasons.push(`file count ${files}`);
                }
                if (reasons.length) {
                  message += ` Guard limits hit: ${reasons.join('; ')}.`;
                }
              } else {
                message += ` Guard status: ${status}.`;
              }
              core.setFailed(message);
            } catch (error) {
              core.setFailed(`Failed to read guard report: ${error}`);
            }

      - name: Record audit entry (dry run)
        if: steps.context.outputs.should_run == 'true' && steps.guard.outcome != 'failure'
        run: |
          set -euo pipefail
          python -m scripts.workorder_audit \
            --trigger "pr-sanity" \
            --source-pr "${{ steps.context.outputs.source_pr || github.event.number }}" \
            --source-head "${{ steps.context.outputs.source_head || github.event.pull_request.head.ref }}" \
            --head-branch "${{ github.event.pull_request.head.ref }}" \
            --pr-base "${{ github.event.pull_request.base.ref }}" \
            --log tmp/workorder_audit_pr.json \
            --artifact tmp/workorder_audit_entry.json \
            --skip-append

      - name: Upload guard report
        if: steps.context.outputs.should_run == 'true' && hashFiles(env.WORKORDER_RUN_REPORT) != ''
        uses: actions/upload-artifact@v4
        with:
          name: workorder-pr-guard-report
          path: ${{ env.WORKORDER_RUN_REPORT }}

      - name: Upload audit entry
        if: steps.context.outputs.should_run == 'true' && hashFiles('tmp/workorder_audit_entry.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: workorder-pr-audit-entry
          path: tmp/workorder_audit_entry.json

      - name: Cleanup modified files
        if: steps.context.outputs.should_run == 'true'
        run: |
          git checkout -- docs/agile/workorder.md workorder_sync_plan.json || true

      - name: Write summary
        if: steps.context.outputs.should_run == 'true'
        run: |
          {
            echo "### workorder-ready/pr-sanity"
            if [ "${{ steps.guard.outcome }}" = "failure" ]; then
              echo "- Result: failure"
            else
              echo "- Result: success"
              if [ -f tmp/workorder_audit_entry.json ]; then
                echo
                echo '\`workorder_audit_entry.json\` ã‚’ artifact ã«ä¿å­˜ã—ã¾ã—ãŸã€‚'
              fi
            fi
          } >> "$GITHUB_STEP_SUMMARY"
