name: workflow-run-debug

on:
  workflow_run:
    workflows:
      - plan-sync/Validate
      - plan-sync.yml
      - plan-validate.yml
    types:
      - completed

permissions:
  contents: read

jobs:
  capture:
    runs-on: ubuntu-latest
    steps:
      - name: Dump context
        uses: actions/github-script@v7
        with:
          script: |
            core.info(`event: ${context.eventName}`);
            const run = context.payload.workflow_run;
            if (!run) {
              core.info('No workflow_run payload.');
              return;
            }
            core.info(`workflow_run.id=${run.id}`);
            core.info(`workflow_run.name=${run.name}`);
            core.info(`workflow_run.event=${run.event}`);
            core.info(`workflow_run.conclusion=${run.conclusion}`);
            core.info(`workflow_run.head_branch=${run.head_branch}`);
            core.info(`workflow_run.head_sha=${run.head_sha}`);
            core.info(`workflow_run.path=${run.path}`);
            core.info(`workflow_run.run_attempt=${run.run_attempt}`);
            core.info(`workflow_run.created_at=${run.created_at}`);
            core.info(`workflow_run.updated_at=${run.updated_at}`);
            core.info(`workflow_run.triggering_actor=${run.triggering_actor && run.triggering_actor.login}`);
            const pull = Array.isArray(run.pull_requests) && run.pull_requests[0];
            if (pull) {
              core.info(`pull.number=${pull.number}`);
              core.info(`pull.head.ref=${pull.head && pull.head.ref}`);
              core.info(`pull.head.sha=${pull.head && pull.head.sha}`);
            }
      - name: Post summary
        run: |
          {
            echo "### workflow-run payload"
            echo "- event: ${{ github.event_name }}"
            echo "- source workflow: ${{ github.event.workflow_run.name || 'unknown' }}"
            echo "- source event: ${{ github.event.workflow_run.event || 'unknown' }}"
            echo "- head branch: ${{ github.event.workflow_run.head_branch || 'unknown' }}"
            echo "- head sha: ${{ github.event.workflow_run.head_sha || 'unknown' }}"
          } >> "$GITHUB_STEP_SUMMARY"
