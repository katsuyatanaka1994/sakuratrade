name: soft-guard-alert
on:
  pull_request:
    types: [closed]

permissions:
  contents: read
  pull-requests: read
  issues: write

concurrency:
  group: soft-guard-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  alert:
    if: ${{ github.event.pull_request.merged == true }}
    permissions:
      contents: read
      pull-requests: read
      issues: write
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const number = context.payload.pull_request.number;
            const prUrl = context.payload.pull_request.html_url;
            const title = `Soft guard violation: PR #${number} merged with docs:invalid`;

            const existing = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: 'open', per_page: 100 }
            );
            if (existing.some(i => i.title === title)) {
              core.info('issue already exists; skip');
              core.setOutput('hasInvalid', 'false');
              return;
            }

            const labels = await github.paginate(
              github.rest.issues.listLabelsOnIssue,
              { owner, repo, issue_number: number }
            );
            const hasInvalid = labels.some(l => l.name === 'docs:invalid');
            core.setOutput('hasInvalid', String(hasInvalid));

            if (hasInvalid) {
              await github.rest.issues.create({ owner, repo, title, body: prUrl });
              core.info(`created issue for PR #${number}`);
            } else {
              core.info('no docs:invalid on merged PR; no issue needed');
            }

      - if: ${{ steps.check.outputs.hasInvalid == 'true' && env.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"⚠️ Soft guard violation: PR #${{ github.event.pull_request.number }} merged with docs:invalid — ${{ github.event.pull_request.html_url }}\"}" \
            "$SLACK_WEBHOOK_URL"
